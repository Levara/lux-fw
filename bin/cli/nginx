#!/usr/bin/env ruby

command = ARGV[0]

ROOT   = Dir.pwd
FOLDER = Dir.pwd.split('/').last

@local_conf  = './config/nginx.conf'
@target_conf = '/etc/nginx/sites-enabled/%s.conf' % FOLDER

def build_conf
  conf = File.read(@local_conf) rescue LuxCli.die('Local conf %s not found' % @local_conf)

  LuxCli.die('$ROOT not found in config') unless conf.include?('$ROOT')

  conf = conf.gsub(/`([^`]+)`/) { `#{$1}`.chomp }
  conf = conf.gsub('$ROOT', ROOT)
  conf = conf.gsub('$FOLDER', FOLDER)
  conf
end

case command
  when 'show'
    puts build_conf
  when 'install'
    File.write './tmp/nginx.conf', build_conf
    puts '# run this manualy'
    puts
    puts 'sudo cp ./tmp/nginx.conf %s && sudo nginx -t' % @target_conf
  else
    puts ' show      # show rendered config'
    puts ' install   # install config/nginx.conf to %s' % @target_conf
end

